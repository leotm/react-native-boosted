# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-gradle

name: Java CI with Gradle

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-android:

    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v3

    # JDK

    - name: Set up JDK 18
      uses: actions/setup-java@v3.1.1
      with:
        java-version: 18
        distribution: temurin

    # TODO: Remove: if: always()

    # NDK

    - name: Android NDK toolchain Setup
      uses: ravinderjangra/android-ndk-toolchain-setup@0.2
      with:
        api: 21 # default
        arch: 'x86_64' # platform
        install-location: 'toolchains' # NDK tollchain path
        force: true # install toolchain, default false

    - name: Set up NDK r24
      if: always()
      uses: nttld/setup-ndk@v1.0.6
      with:
        ndk-version: r24

      # r22
      # r23b
      # r24
      # r25-beta2

    - name: Install with Yarn
      if: always()
      run: yarn

    - name: Debug info
      if: always()
      run: npx react-native info

    - name: Clean with Gradle
      if: always()
      run: cd android && ./gradlew clean

    - name: Clean with Gradle (x86_64)
      if: always()
      run: cd android && ./gradlew clean -PreactNativeArchitectures=x86_64
      
    # - name: Build project Make-based (not CMake)
    #   run: |
    #     /usr/local/lib/android/sdk/ndk/21.4.7075529/ndk-build
    #     NDK_PROJECT_PATH=null
    #     APP_BUILD_SCRIPT=/home/runner/work/react-native-template-new-architecture/react-native-template-new-architecture/node_modules/react-native/ReactAndroid/src/main/jni/react/jni/Android.mk
    #      NDK_APPLICATION_MK=/home/runner/work/react-native-template-new-architecture/react-native-template-new-architecture/node_modules/react-native/ReactAndroid/src/main/jni/Application.mk

    - name: Build with Gradle
      if: always()
      run: cd android && ./gradlew assembleDebug

    # - name: Remove build cache
      # run: rm -rf app/build

    - name: Build with Gradle
      if: always()
      run: cd android && ./gradlew assembleDebug

    - name: Build with Gradle (x86_64)
      if: always()
      run: cd android && ./gradlew assembleDebug -PreactNativeArchitectures=x86_64

    - name: Build with Gradle (action)
      if: always()
      uses: gradle/gradle-build-action@v2.1.5
      with:
        arguments: assembleDebug
        build-root-directory: android

    - name: Build with Gradle (action)
      if: always()
      uses: gradle/gradle-build-action@v2.1.5
      with:
        arguments: assembleDebug
        build-root-directory: android
